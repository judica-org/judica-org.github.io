<!doctype html><html><head><meta name=viewport content="width=device-width,initial-scale=1"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@200;500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href=/css/style.css><script>const storage=window.localStorage,get_darkmode=()=>{const e=storage.getItem("darkmode");return e==null||e==="true"},set_darkmode=()=>{get_darkmode()?(document.body.classList.remove("lightmode"),document.body.classList.add("darkmode")):(document.body.classList.remove("darkmode"),document.body.classList.add("lightmode"))};function applyBackgroundTheme(e){var n="body { background: "+e+"; }",s=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");return s.appendChild(t),t.type="text/css",t.styleSheet?t.styleSheet.cssText=n:t.appendChild(document.createTextNode(n)),t}const style=applyBackgroundTheme(get_darkmode()?"black":"white");document.addEventListener("DOMContentLoaded",()=>{set_darkmode(),style.parentElement.removeChild(style);const e=document.getElementsByClassName("darkmode-switch")[0];e.onclick=e=>{storage.setItem("darkmode",!get_darkmode()),get_darkmode(),set_darkmode()}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-175497336-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Sapio Tutorial Sneak Peak"><meta property="og:description" content="Learn how to use Sapio to make smart contracts on Bitcoin"><meta property="og:type" content="article"><meta property="og:url" content="https://judica.org/blog/sapio-tutorial/"><meta property="og:image" content="https://judica.org/img/sapio-logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-08-02T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-02T00:00:00+00:00"><meta property="og:site_name" content="judica.org -- restore the balance"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://judica.org/img/sapio-logo.png"><meta name=twitter:title content="Sapio Tutorial Sneak Peak"><meta name=twitter:description content="Learn how to use Sapio to make smart contracts on Bitcoin"></head><body><header class=nav><ul><li class=float-left><a href=/>judica.</a></li></ul><ul><li><a href=/about/>about.</a></li><li><a href=/software/>software.</a></li><li><a href=/blog/>blog.</a></li><li><a href=/join/>join.</a></li></ul></header><div class=main2><h1>Sapio Tutorial Sneak Peak</h1><small>on August 2, 2020</small><hr></div><div class=main2><div></div><div class=blogtext-inner><p>We&rsquo;ve been hard at work getting Sapio ready for release, but I figured it would be a good time to
share some early documentation & basic tutorial to make <a href=/sapio/>Sapio</a> a little more concrete.</p><p>Enjoy the sneak peak!</p><h3 id=why-is-sapio-different>Why is Sapio Different?</h3><p>Sapio helps you build payment protocol specifiers that oblivious third parties
can participate in being none the wiser.</p><p>For example, with Sapio you can generate an address that represents a lightning
channel between you and friend and give that address to a third party service
like an exchange and have them create the channel without requiring any
signature interaction from you or your friend, zero trusted parties, and an
inability to differentiate your address from any other.</p><p>That&rsquo;s the tip of the iceberg of what Sapio lets you accomplish.</p><h4 id=say-more>Say more&mldr;</h4><p>Before Sapio, most Bitcoin smart contracts primarily focused on who can redeem
coins when and what unlocking conditions were required (see Ivy,
Policy/Miniscript, etc). A few languages, such as BitML, placed emphasis on
multi-transaction and multi-party use cases.</p><p>Sapio in particular focuses on transactions using BIP-119
<code>OP_CHECKTEMPLATEVERIFY</code>. <code>OP_CHECKTEMPLATEVERIFY</code> enables Bitcoin Script to support
complex multi-step smart contracts without a trusted setup.</p><p>Sapio is a tool for defining such smart contracts in an easy way and exporting
easy to integrate APIs for managing open contracts. With Sapio you can turn what
previously would require months or years of careful tinkering with Bitcoin
internals into a 20 minute project and get a fully functional Bitcoin
application.</p><p>Sapio has intelligent built in features which help developers design safe smart
contracts and limit risk of losing funds.</p><p>For more information on Sapio, check out this Reckless VR Talk <a href="https://www.youtube.com/watch?v=4vDuttlImPc">Sapio: Stateful Smart Contracts
for Bitcoin with OP_CTV</a> and
<a href=https://docs.google.com/presentation/d/1X4AGNXJ5yCeHRrf5sa9DarWfDyEkm6fFUlrcIRQtUw4>slides</a>.</p><h3 id=show-me-the-money-sapio-crash-course>Show Me The Money! Sapio Crash Course:</h3><p>Let&rsquo;s look at some example Sapio contracts.</p><p>A Basic Pay to Public Key contract can be generated as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PayToPublicKey</span>(Contract):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Fields</span>:
</span></span><span style=display:flex><span>        key: PubKey
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@unlock</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_key</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> SignedBy(self<span style=color:#f92672>.</span>key)
</span></span></code></pre></div><p>Now let&rsquo;s look at an Escrow Contract. Here either Alice and Escrow, Bob and
Escrow, or Alice and Bob can spend the funds. Note that we use logic notation
where (|) is OR and (&) is and. These can also be written as <code>Or(a,b)</code> and
<code>And(a,b)</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BasicEscrow</span>(Contract):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Fields</span>:
</span></span><span style=display:flex><span>        alice: PubKey
</span></span><span style=display:flex><span>        bob: PubKey
</span></span><span style=display:flex><span>        escrow: PubKey
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@unlock</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>redeem</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> SignedBy(self<span style=color:#f92672>.</span>escrow) <span style=color:#f92672>&amp;</span> (SignedBy(self<span style=color:#f92672>.</span>alice) <span style=color:#f92672>|</span> SignedBy(self<span style=color:#f92672>.</span>bob)) <span style=color:#f92672>|</span> (
</span></span><span style=display:flex><span>            SignedBy(self<span style=color:#f92672>.</span>alice) <span style=color:#f92672>&amp;</span> SignedBy(self<span style=color:#f92672>.</span>bob)
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><p>We can also write this a bit more clearly as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BasicEscrow2</span>(Contract):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Fields</span>:
</span></span><span style=display:flex><span>        alice: PubKey
</span></span><span style=display:flex><span>        bob: PubKey
</span></span><span style=display:flex><span>        escrow: PubKey
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@unlock</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>use_escrow</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> SignedBy(self<span style=color:#f92672>.</span>escrow) <span style=color:#f92672>&amp;</span> (SignedBy(self<span style=color:#f92672>.</span>alice) <span style=color:#f92672>|</span> SignedBy(self<span style=color:#f92672>.</span>bob))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@unlock</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cooperate</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> SignedBy(self<span style=color:#f92672>.</span>alice) <span style=color:#f92672>&amp;</span> SignedBy(self<span style=color:#f92672>.</span>bob)
</span></span></code></pre></div><p>Until this point, we haven&rsquo;t made use of any of the <code>CheckTemplateVerify</code>
functionality of Sapio. These could all be done in Bitcoin today.</p><p>But Sapio lets us go further. What if we wanted to protect from Alice and the
escrow or Bob and the escrow from cheating?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TrustlessEscrow</span>(Contract):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Fields</span>:
</span></span><span style=display:flex><span>        alice: PubKey
</span></span><span style=display:flex><span>        bob: PubKey
</span></span><span style=display:flex><span>        alice_escrow: Tuple[Amount, Contract]
</span></span><span style=display:flex><span>        bob_escrow: Tuple[Amount, Contract]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@guarantee</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>use_escrow</span>(self) <span style=color:#f92672>-&gt;</span> TransactionTemplate:
</span></span><span style=display:flex><span>        tx <span style=color:#f92672>=</span> TransactionTemplate()
</span></span><span style=display:flex><span>        tx<span style=color:#f92672>.</span>add_output(<span style=color:#f92672>*</span>self<span style=color:#f92672>.</span>alice_escrow)
</span></span><span style=display:flex><span>        tx<span style=color:#f92672>.</span>add_output(<span style=color:#f92672>*</span>self<span style=color:#f92672>.</span>bob_escrow)
</span></span><span style=display:flex><span>        tx<span style=color:#f92672>.</span>set_sequence(Days(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> tx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@unlock</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cooperate</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> SignedBy(self<span style=color:#f92672>.</span>alice) <span style=color:#f92672>&amp;</span> SignedBy(self<span style=color:#f92672>.</span>bob)
</span></span></code></pre></div><p>Now with <code>TrustlessEscrow</code>, we&rsquo;ve done a few things differently. A <code>@guarantee</code>
designator tells the contract compiler to add a branch which <em>must</em> create the
returned transaction if that branch is taken. We&rsquo;ve also passed in a
sub-contract for both Alice and Bob to allow us to specify at a higher layer
what kind of pay out they receive. Lastly, we used a call to <code>set_sequence</code> to
specify that we should have to wait 10 days before using the escrow (we could
pass this as a parameter if we wanted though).</p><p>Thus we could construct an instance of this contract as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>key_alice <span style=color:#f92672>=</span> <span style=color:#75715e>#...</span>
</span></span><span style=display:flex><span>key_bob <span style=color:#f92672>=</span> <span style=color:#75715e>#...</span>
</span></span><span style=display:flex><span>t <span style=color:#f92672>=</span> TrustlessEscrow(alice<span style=color:#f92672>=</span>key_alice,
</span></span><span style=display:flex><span>                    bob<span style=color:#f92672>=</span>key_bob,
</span></span><span style=display:flex><span>                    alice_escrow<span style=color:#f92672>=</span>(Bitcoin(<span style=color:#ae81ff>1</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_alice)),
</span></span><span style=display:flex><span>                    bob_escrow<span style=color:#f92672>=</span>(Sats(<span style=color:#ae81ff>10000</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_bob)))
</span></span></code></pre></div><p>The power of Sapio becomes apparent when you look at the composability of the
framework. We can also put an escrow inside an escrow:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>key_alice <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>key_bob <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>t <span style=color:#f92672>=</span> TrustlessEscrow(
</span></span><span style=display:flex><span>    alice<span style=color:#f92672>=</span>key_alice,
</span></span><span style=display:flex><span>    bob<span style=color:#f92672>=</span>key_bob,
</span></span><span style=display:flex><span>    alice_escrow<span style=color:#f92672>=</span>(Bitcoin(<span style=color:#ae81ff>1</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_alice)),
</span></span><span style=display:flex><span>    bob_escrow<span style=color:#f92672>=</span>(Sats(<span style=color:#ae81ff>10000</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_bob)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>t1 <span style=color:#f92672>=</span> TrustlessEscrow(
</span></span><span style=display:flex><span>    alice<span style=color:#f92672>=</span>key_alice,
</span></span><span style=display:flex><span>    bob<span style=color:#f92672>=</span>key_bob,
</span></span><span style=display:flex><span>    alice_escrow<span style=color:#f92672>=</span>(Bitcoin(<span style=color:#ae81ff>1</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_alice)),
</span></span><span style=display:flex><span>    bob_escrow<span style=color:#f92672>=</span>(Sats(<span style=color:#ae81ff>10000</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_bob)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>t2 <span style=color:#f92672>=</span> TrustlessEscrow(
</span></span><span style=display:flex><span>    alice<span style=color:#f92672>=</span>key_alice,
</span></span><span style=display:flex><span>    bob<span style=color:#f92672>=</span>key_bob,
</span></span><span style=display:flex><span>    alice_escrow<span style=color:#f92672>=</span>(Bitcoin(<span style=color:#ae81ff>1</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_alice)),
</span></span><span style=display:flex><span>    bob_escrow<span style=color:#f92672>=</span>(Sats(<span style=color:#ae81ff>10000</span>) <span style=color:#f92672>+</span> Bitcoin(<span style=color:#ae81ff>1</span>), t1),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># t3 throws an error because we would lose value</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    t3 <span style=color:#f92672>=</span> TrustlessEscrow(
</span></span><span style=display:flex><span>        alice<span style=color:#f92672>=</span>key_alice,
</span></span><span style=display:flex><span>        bob<span style=color:#f92672>=</span>key_bob,
</span></span><span style=display:flex><span>        alice_escrow<span style=color:#f92672>=</span>(Bitcoin(<span style=color:#ae81ff>1</span>), PayToPublicKey(key<span style=color:#f92672>=</span>key_alice)),
</span></span><span style=display:flex><span>        bob_escrow<span style=color:#f92672>=</span>(Sats(<span style=color:#ae81ff>10000</span>), t1),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ValueError</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>Sapio will look to make sure that all paths of our contract are sufficiently
funded, only losing an amount for fees (user configurable).</p><p>If you wanted to fund this contract from an exchange, all you need to do is request a withdrawal of the form:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(t2<span style=color:#f92672>.</span>amount_range[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>/</span><span style=color:#ae81ff>100e6</span>, t2<span style=color:#f92672>.</span>witness_manager<span style=color:#f92672>.</span>get_p2wsh_address())
</span></span><span style=display:flex><span><span style=color:#ae81ff>2.0001</span> bcrt1qh4ddpny622fcjf5m02nmdare7wgsuys5sau3jh5tdhm2kzwg9rzqw2sk00
</span></span></code></pre></div></div><div></div></div><hr><div class=main2><div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//judica-org.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div></div></div><hr><footer style=text-align:center;bottom:0;padding-bottom:10px;width:100%>&copy; Judica, Inc 2022 | contact@judica.org | <a class=darkmode-switch>dark/light theme</a></footer></body></html>